# 尚学堂JDBC学习笔记

[TOC]

## 写在前面

学习链接：[Java JDBC 视频教程全集](https://www.bilibili.com/video/av59534040/)

学习体会：

1. 我觉得废话有点多，同一个知识点翻来覆去的讲，并且有的疑点还没解决。比如说：比如说：利用Driver和DriverManager都能用不同的数据库，为什么DriverManager更好。视频中说的两个优点我觉得Driver也能做到啊，没搞懂为什么。
2. 由于本人已经学过了高琪老师的java300集，其中包括了JDBC的内容，因此仅以此视频作为查漏补缺。
3. 视频中涉及到的练习，进行了简化学习。

## 第1天

### 1. 通过Driver接口获取数据库连接

- 数据持久化

- 数据库存取技术分类

  - JDBC直接访问数据库
  - JDO技术
  - 第三方O/R工具，如Hibernate，ibatis等

- JDBC是java访问数据库的基石

- JDBC（Java Database Connectivity）是一个独立于特定数据库管理系统、通用的SQL数据库存取和操作的公共接口。

   ![img](https://img-blog.csdnimg.cn/20191210182445192.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzIxNTc5MDQ1,size_16,color_FFFFFF,t_70)
   
- JDBC接口（API）包括两个层次：

   - 面向应用的API：java api，抽象接口，供应用程序开发人员使用（连接数据库，执行SQL语句，获得结果）。
   - 面向数据库的API：java driver api，供开发商开发数据库驱动程序用。

- JDBC试验，Driver是一个接口：数据库厂商必须提供实现的接口，能从其中获取数据库连接。

- 可以通过Driver的实现类对象获取数据库连接

   - 加入mysql驱动
      - 解压mysql-connector-java.zip
      - 在挡墙项目下新建lib目录
      - 吧.jar文件复制到lib目录下
      - 右键buildpath，add to buildpath加入到类路径下
   - JDBC的URL的标准由三部分组成，各部分间用冒号分隔。
      - jdbc:<子协议>:<子名称>
      - 协议：JDBC URL中的协议总是jdbc
      - 子协议：子协议用于标识一个数据库驱动程序
      - 子名称：一种标识数据库的方法。子名称可以依不同的子协议而变化，用子名称的目的是为了定位数据库提供足够的信息。
   - 遇到的问题：
      - 进不去，各种报错：可能是密码错误了。[参考](https://blog.csdn.net/QQ17680473835/article/details/81841180)
      - time zone错误：[参考](https://blog.csdn.net/qq_19332219/article/details/102847809)

   ```java
   package com.litian.jdbc;
   import java.sql.Connection;
   import java.sql.Driver;
   import java.sql.SQLException;
   import java.util.Properties;
   
   
   /**
    * @author: Li Tian
    * @contact: litian_cup@163.com
    * @software: IntelliJ IDEA
    * @file: JDBCTest.java
    * @time: 2019/12/15 18:56
    * @desc: JDBC试验，Driver是一个接口：数据库厂商必须提供实现的接口，能从其中获取数据库连接。
    */
   
   public class JDBCTest {
       public static void main(String[] args) throws SQLException {
           // 1. 创建一个Driver实现类的对象
           Driver driver = new com.mysql.jdbc.Driver();
           // 2. 准备连接数据库的基本信息：url，user，password
           String url = "jdbc:mysql://localhost:3306/girls";
           Properties info = new Properties();
           info.put("user", "root");
           info.put("password", "tian19951103");
   
           // 3. 调用Driver接口的connect(url, info)获取数据库连接
           Connection connection = driver.connect(url, info);
           System.out.println(connection);
       }
   }
   ```

- 编写一个通用的方法，在不修改源程序的情况下，可以获取任何数据库的连接

- 解决方案：把数据库驱动Driver 实现类的全类名、url、user、password放入一个配置文件中，通过修改配置文件的方式实现和具体的数据库解耦。

   - jdbc.properties

      ```properties
      driver=com.mysql.jdbc.Driver
      jdbcUrl=jdbc:mysql://localhost:3306/girls
      user=root
      password=tian19951103
      ```

   - JDBCTest

      ```java
      package com.litian.jdbc;
      
      import java.io.InputStream;
      import java.sql.Connection;
      import java.sql.Driver;
      import java.sql.SQLException;
      import java.util.Properties;
      
      
      /**
       * @author: Li Tian
       * @contact: litian_cup@163.com
       * @software: IntelliJ IDEA
       * @file: JDBCTest.java
       * @time: 2019/12/15 18:56
       * @desc: JDBC试验，Driver是一个接口：数据库厂商必须提供实现的接口，能从其中获取数据库连接。
       */
      
      public class JDBCTest {
      
          public void test1() throws SQLException {
              // 1. 创建一个Driver实现类的对象
              Driver driver = new com.mysql.jdbc.Driver();
              // 2. 准备连接数据库的基本信息：url，user，password
              String url = "jdbc:mysql://localhost:3306/girls";
              Properties info = new Properties();
              info.put("user", "root");
              info.put("password", "tian19951103");
      
              // 3. 调用Driver接口的connect(url, info)获取数据库连接
              Connection connection = driver.connect(url, info);
              System.out.println(connection);
          }
      
          // 编写一个通用的方法，在不修改源程序的情况下，可以获取任何数据库的连接
          public Connection getConnection() throws Exception {
              String driverClass = null;
              String jdbcUrl = null;
              String user = null;
              String password = null;
      
              // 读取类路径下的jdbc.propertites 文件
              InputStream in = getClass().getClassLoader().getResourceAsStream("jdbc.properties");
              Properties properties = new Properties();
              properties.load(in);
              driverClass = properties.getProperty("driver");
              jdbcUrl = properties.getProperty("jdbcUrl");
              user = properties.getProperty("user");
              password = properties.getProperty("password");
      
              Driver driver = (Driver) Class.forName(driverClass).newInstance();
      
              Properties info = new Properties();
              info.put("user", user);
              info.put("password", password);
              Connection connection = driver.connect(jdbcUrl, info);
      
              return connection;
          }
      
          public void testGetConnection() throws Exception {
              System.out.println(getConnection());
          }
      
          public static void main(String[] args) throws Exception {
              new JDBCTest().testGetConnection();
          }
      }
      ```

### 2. 通过DriverManager获取数据库连接

- 修改一下配置文件

  ```properties
  driver=com.mysql.cj.jdbc.Driver
  jdbcUrl=jdbc:mysql://localhost:3306/testjdbc?serverTimezone=GMT%2B8
  user=root
  password=123456
  ```

- 代码（我觉得废话有点多，同一个知识点翻来覆去的讲，并且有的疑点还没解决）

- 比如说：利用Driver和DriverManager都能用不同的数据库，为什么DriverManager更好

  ```java
  package com.litian.jdbc;
  
  import java.io.InputStream;
  import java.sql.Connection;
  import java.sql.Driver;
  import java.sql.DriverManager;
  import java.sql.SQLException;
  import java.util.Properties;
  
  
  /**
   * @author: Li Tian
   * @contact: litian_cup@163.com
   * @software: IntelliJ IDEA
   * @file: JDBCTest.java
   * @time: 2019/12/15 18:56
   * @desc: JDBC试验，Driver是一个接口：数据库厂商必须提供实现的接口，能从其中获取数据库连接。
   */
  
  public class JDBCTest {
  
      public Connection getConnection2() throws Exception {
          // 1. 准备连接数据库的4个字符串。
          // 1.1 创建Properties对象
          Properties properties = new Properties();
          // 1.2 获取jdbc.properties对应的输入流
          InputStream in = this.getClass().getClassLoader().getResourceAsStream("jdbc.properties");
          // 1.3 加载1.2对应的输入流
          properties.load(in);
          // 1.4 具体决定user，password等4个字符串。
          String user = properties.getProperty("user");
          String password = properties.getProperty("password");
          String jdbcUrl = properties.getProperty("jdbcUrl");
          String driver = properties.getProperty("driver");
          // 2. 加载数据库驱动程序
          Class.forName(driver);
          // 3. 通过DriverManager的getConnection()方法获取数据库连接。
          return DriverManager.getConnection(jdbcUrl, user, password);
      }
  
      /**
       * DriverManager是驱动的管理类
       * 1. 可以通过重载的getConnection()方法获取数据库连接。较为方便
       * 2. 可以同时管理多个驱动程序：若注册了多个数据库连接，则调动getConnection()方法时
       *    传入的参数不同，则返回不同的数据库连接
       */
      public void testDriverManager() throws Exception {
          // 1. 准备连接数据库的4个字符串
  
          // 驱动的全类名
          String driverClass = null;
          String jdbcUrl = null;
          String user = null;
          String password = null;
  
          // 读取类路径下的jdbc.propertites 文件
          InputStream in = getClass().getClassLoader().getResourceAsStream("jdbc.properties");
          Properties properties = new Properties();
          properties.load(in);
          driverClass = properties.getProperty("driver");
          jdbcUrl = properties.getProperty("jdbcUrl");
          user = properties.getProperty("user");
          password = properties.getProperty("password");
  
          // 2. 加载数据库驱动程序（对应的Driver实现类中有注册驱动的静态代码块程序）
          // 下面的注册程序已经写好了，不需要自己写
          // DriverManager.registerDriver((Driver) Class.forName(driverClass).newInstance());
          Class.forName(driverClass);
  
          // 3. 通过DriverManager的getConnection()方法获取数据库连接
          Connection connection = DriverManager.getConnection(jdbcUrl, user, password);
          System.out.println(connection);
  
      }
  
      public void test1() throws SQLException {
          // 1. 创建一个Driver实现类的对象
          Driver driver = new com.mysql.jdbc.Driver();
          // 2. 准备连接数据库的基本信息：url，user，password
          String url = "jdbc:mysql://localhost:3306/girls";
          Properties info = new Properties();
          info.put("user", "root");
          info.put("password", "tian19951103");
  
          // 3. 调用Driver接口的connect(url, info)获取数据库连接
          Connection connection = driver.connect(url, info);
          System.out.println(connection);
      }
  
      // 编写一个通用的方法，在不修改源程序的情况下，可以获取任何数据库的连接
      public Connection getConnection() throws Exception {
          String driverClass = null;
          String jdbcUrl = null;
          String user = null;
          String password = null;
  
          // 读取类路径下的jdbc.propertites 文件
          InputStream in = getClass().getClassLoader().getResourceAsStream("jdbc.properties");
          Properties properties = new Properties();
          properties.load(in);
          driverClass = properties.getProperty("driver");
          jdbcUrl = properties.getProperty("jdbcUrl");
          user = properties.getProperty("user");
          password = properties.getProperty("password");
  
          Driver driver = (Driver) Class.forName(driverClass).newInstance();
  
          Properties info = new Properties();
          info.put("user", user);
          info.put("password", password);
          Connection connection = driver.connect(jdbcUrl, info);
  
          return connection;
      }
  
      public void testGetConnection() throws Exception {
          System.out.println(getConnection());
      }
  
      public static void main(String[] args) throws Exception {
          // new JDBCTest().testGetConnection();
          // new JDBCTest().testDriverManager();
          Connection conn = new JDBCTest().getConnection2();
          System.out.println(conn);
      }
  }
  ```

### 3. 通过Statement执行更新操作

- Statement测试

  ```java
  /**
   * 通过JDBC向指定的数据表中插入一条记录
   * 1. Statement：用于执行sql语句的对象
   * 1.1 通过Connection的createStatement()方法来获取
   * 1.2 通过executeUpdate(sql)可以执行SQL语句
   * 1.3 传入的sql可以是insert, update或delete，但不能是select
   * 2. Connection、Statement都是应用程序和数据库服务器的连接资源。使用后一定要关闭。
   * 2.1 需要再finally中关闭
   * 3. 关闭顺序：先获取的后关，后获取的先关
   */
  public void testStatement() {
      Connection conn = null;
      Statement statement = null;
      try {
          // 1. 获取数据库连接
          conn = getConnection2();
          // 2. 准备插入的SQL语句
          String sql = "insert into t_user (username, pwd) values('测试', 3352)";
          String sql2 = "update t_user set username='傻瓜' where id = 20017";
          // 3. 执行插入
          // 3.1 获取操作sql语句的Statement对象
          statement = conn.createStatement();
          // 3.2 调用Statement对象的executeUpdate(sql)执行SQL语句
          statement.executeUpdate(sql);
      } catch (Exception e) {
          e.printStackTrace();
      } finally {
          try {
              if (statement != null) {
                  // 4. 关闭Statement对象
                  statement.close();
              }
          } catch (SQLException e) {
              e.printStackTrace();
          }
          try {
              if (statement != null) {
                  // 5. 关闭Connection对象
                  conn.close();
              }
          } catch (SQLException e) {
              e.printStackTrace();
          }
      }
  }
  ```

- insert/update/delete封装

  ```java
  /**
   * 通用的更新的方法：insert/update/delete
   * 版本1
   */
  public void update(String sql){
      Connection conn = null;
      Statement statement = null;
  
      try {
          conn = getConnection2();
          statement = conn.createStatement();
          statement.executeUpdate(sql);
      }catch (Exception e){
          e.printStackTrace();
      }finally {
          try {
              if (statement != null) {
                  statement.close();
              }
          } catch (SQLException e) {
              e.printStackTrace();
          }
          try {
              if (statement != null) {
                  conn.close();
              }
          } catch (SQLException e) {
              e.printStackTrace();
          }
      }
  }
  ```

- 创建JDBC的工具类，封装方法

  - 工具类

    ```java
    package com.litian.jdbc;
    
    import java.io.InputStream;
    import java.sql.*;
    import java.util.Properties;
    
    /**
     * @author: Li Tian
     * @contact: litian_cup@163.com
     * @software: IntelliJ IDEA
     * @file: JDBCUtils.java
     * @time: 2020/3/21 15:23
     * @desc: |操作JDBC的工具类，其中封装了一些工具方法
     * Version1
     */
    
    public class JDBCTools {
    
        /**
         * 关闭Statement和Connection的方法
         */
        public static void release(Statement statement, Connection conn) {
            try {
                if (statement != null) {
                    statement.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try {
                if (statement != null) {
                    conn.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    
        public static void release(ResultSet rs, Statement statement, Connection conn) {
            try {
                if (rs != null) {
                    rs.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try {
                if (statement != null) {
                    statement.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
            try {
                if (statement != null) {
                    conn.close();
                }
            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    
        /**
         * 1. 获取连接的方法
         * 通过读取配置文件从数据库服务器获取一个连接。
         *
         * @return
         */
        public static Connection getConnection() throws Exception {
            // 1. 准备连接数据库的4个字符串。
            // 1.1 创建Properties对象
            Properties properties = new Properties();
            // 1.2 获取jdbc.properties对应的输入流
            InputStream in = JDBCTools.class.getClassLoader().getResourceAsStream("jdbc.properties");
            // 1.3 加载1.2对应的输入流
            properties.load(in);
            // 1.4 具体决定user，password等4个字符串。
            String user = properties.getProperty("user");
            String password = properties.getProperty("password");
            String jdbcUrl = properties.getProperty("jdbcUrl");
            String driver = properties.getProperty("driver");
            // 2. 加载数据库驱动程序
            Class.forName(driver);
            // 3. 通过DriverManager的getConnection()方法获取数据库连接。
            return DriverManager.getConnection(jdbcUrl, user, password);
        }
    
    }
    ```

  - 修改后的insert/update/delete封装

    ```java
    public void update(String sql) {
        Connection conn = null;
        Statement statement = null;
    
        try {
            conn = getConnection2();
            statement = conn.createStatement();
            statement.executeUpdate(sql);
        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            JDBCTools.release(statement, conn);
        }
    }
    ```

### 4. 通过ResultSet执行查询操作

```java
/**
 * ResultSet：结果集。封装了使用JDBC进行查询的结果。
 * 1. 调用Statement对象的executeQuery(sql)方法
 * 2. ResultSet返回的实际上就是一张数据表。有一个指针指向数据表的第一行的前面。
 * 可以调用next()方法检测下一行是否有效。若有效，该方法返回true，且指针下移。
 * 相当于Iterator对象的hasNext()和next()方法的结合体
 * 3. 当指针对应到一行时，可以通过嗲用getXXX(index)或getXXX(columnName)获取
 * 每一列的值。如：getInt(1)，getString("name")
 * 4. 关闭ResultSet
 */
public void testResultSet(){
    // 获取各项记录，并打印
    Connection conn = null;
    Statement statement = null;
    ResultSet rs = null;
    try {
        // 1. 获取Connection
        conn = JDBCTools.getConnection();
        // 2. 获取Statement
        statement = conn.createStatement();
        // 3. 准备SQL
        String sql = "select id, username, pwd, regTime, lastLoginTime from t_user";
        // 4. 执行查询，得到ResultSet
        rs = statement.executeQuery(sql);
        // 5. 处理ResultSet
        while(rs.next()){
            int id = rs.getInt(1);
            String username = rs.getString(2);
            String pwd = rs.getString(3);
            Date regTime = rs.getDate(4);
            Timestamp lastLoginTime = rs.getTimestamp(5);
            System.out.println(id + "-->" + username + "-->" + pwd + "-->" + regTime + "-->" + lastLoginTime);
        }
        // 6. 关闭数据库资源
    } catch (Exception e) {
        e.printStackTrace();
    } finally {
        JDBCTools.release(rs, statement, conn);
    }
}
```

- 以面向对象的思想编写JDBC程序
  - 将数据表中的属性封装为一个类，增删改变为从类到数据库，查变为从数据库到类。

### 5. PreparedStatement

- 是Statement的子接口，可以传入带占位符的sql语句，并且提供了补充占位符变量的方法。

- 使用Statement需要进行拼写SQL语句，很辛苦，很容易出错。

- 引号的问题处理很复杂，不利于维护。

- 可以有效的禁止sql注入。(通过用户输入非法的sql命令)

- 代码的可读性和可维护性，最大可能的提高性能（批量插入）

- 代码测试

  ```java
  public void testPreparedStatement() {
      Connection connection = null;
      PreparedStatement ps = null;
  
      try {
          connection = JDBCTools.getConnection();
          String sql = "insert into t_user (id, username, pwd, regTime, lastLoginTime) values(?,?,?,?,?)";
          ps = connection.prepareStatement(sql);
          ps.setInt(1, 2);
          ps.setString(2, "狗贼");
          ps.setString(3, "123456");
          ps.setDate(4, new Date(System.currentTimeMillis()));
          ps.setTimestamp(5, new Timestamp(System.currentTimeMillis()));
          ps.executeUpdate();
      } catch (Exception e) {
          e.printStackTrace();
      } finally {
          JDBCTools.release(ps, connection);
      }
  }
  ```

- 



------

我的CSDN：https://blog.csdn.net/qq_21579045

我的博客园：https://www.cnblogs.com/lyjun/

我的Github：https://github.com/TinyHandsome

纸上得来终觉浅，绝知此事要躬行~

欢迎大家过来OB~

by 李英俊小朋友